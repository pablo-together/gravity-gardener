<!DOCTYPE html>
<html>
<head>
    <title>The Gravity Gardener - Final Edition</title>
    <style>
        body {
            background-color: #1a1a2e;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 10px;
            user-select: none;
        }
        h1 { margin-bottom: 5px; text-shadow: 0 0 10px #4488FF; }
        p { margin-top: 0; color: #aaa; font-size: 14px; }
        
        #gameCanvas {
            background-color: #000;
            border: 3px solid #4488FF;
            border-radius: 10px;
            cursor: crosshair;
            box-shadow: 0 0 30px rgba(0, 100, 255, 0.2);
        }

        .panel {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        button {
            padding: 8px 16px; font-size: 14px; cursor: pointer;
            color: white; border: none; border-radius: 4px; font-weight: bold;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }
        
        .btn-launch { background-color: #00C853; } 
        .btn-reset  { background-color: #FF9800; } 
        .btn-clear  { background-color: #D50000; } 
        .btn-set    { background-color: #2196F3; }

        .size-btn { background-color: #444; border: 2px solid #555; }
        .size-btn.active { border-color: #fff; background-color: #666; }

        input[type="number"] {
            padding: 5px; border-radius: 4px; border: none;
            width: 60px; text-align: center; font-weight: bold;
        }

    </style>
</head>
<body>

    <h1>üöÄ Mission: Earth Return</h1>
    <p>Left Click: Add Moon | Right Click: Delete Moon</p>
    
    <canvas id="gameCanvas" width="800" height="500"></canvas>

    <div class="panel">
        <span>Moon Size:</span>
        <button id="btnSmall" class="size-btn" onclick="setMoonSize(50, this)">Small</button>
        <button id="btnMed" class="size-btn active" onclick="setMoonSize(150, this)">Medium</button>
        <button id="btnLarge" class="size-btn" onclick="setMoonSize(400, this)">Large</button>
        
        <span style="margin-left: 20px;">Speed:</span>
        <input type="number" id="speedInput" value="2" step="0.5">

        <span style="margin-left: 10px;">Gravity:</span>
        <input type="number" id="gravityInput" value="1000" step="500">
        <button class="btn-set" id="setGravityBtn">Set</button>
    </div>

    <div class="panel">
        <button class="btn-launch" id="launchBtn">üöÄ LAUNCH</button>
        <button class="btn-reset" id="resetBtn">üîÑ Reset Rocket</button>
        <button class="btn-clear" id="clearBtn">üóëÔ∏è Clear Space</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // --- GAME STATE ---
        let isSimulating = false;
        let moons = [];
        let particles = []; // New: Holds all our explosion/confetti dots
        let currentMass = 150;
        let gravityConstant = 1000;
        let gameStatus = "PLANNING"; 

        // --- MATH HELPERS ---
        class Vector {
            constructor(x, y) { this.x = x; this.y = y; }
            add(v) { this.x += v.x; this.y += v.y; }
            sub(v) { return new Vector(this.x - v.x, this.y - v.y); }
            mult(n) { return new Vector(this.x * n, this.y * n); }
            mag() { return Math.sqrt(this.x * this.x + this.y * this.y); }
            dist(v) { return this.sub(v).mag(); }
            normalize() {
                let m = this.mag();
                if (m > 0) return new Vector(this.x / m, this.y / m);
                return new Vector(0,0);
            }
        }

        // --- PARTICLE SYSTEM (New!) ---
        class Particle {
            constructor(x, y, type) {
                this.position = new Vector(x, y);
                this.type = type; // "fire" or "confetti"
                this.life = 1.0; // Starts at 100% visible
                
                // Random Explosion Speed
                let angle = Math.random() * Math.PI * 2;
                let speed = Math.random() * (type === "fire" ? 3 : 5);
                this.velocity = new Vector(Math.cos(angle) * speed, Math.sin(angle) * speed);

                // Colors
                if (type === "fire") {
                    const colors = ["#FF5722", "#FF9800", "#FFC107"];
                    this.color = colors[Math.floor(Math.random() * colors.length)];
                    this.decay = 0.03; // Fades fast
                } else {
                    const colors = ["#00E676", "#2979FF", "#E040FB", "#FFFF00"];
                    this.color = colors[Math.floor(Math.random() * colors.length)];
                    this.decay = 0.01; // Fades slow
                }
            }

            update() {
                this.position.add(this.velocity);
                this.life -= this.decay;
                
                if (this.type === "confetti") {
                    this.velocity.y += 0.1; // Confetti falls down (gravity)
                    this.velocity.x *= 0.95; // Air resistance slows it sideways
                }
            }

            draw(ctx) {
                ctx.save();
                ctx.globalAlpha = Math.max(0, this.life); // Fade out
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.position.x, this.position.y, this.type === "fire" ? 6 : 4, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        // --- OBJECTS ---
        class Rocket {
            constructor() {
                this.startPos = new Vector(50, canvas.height / 2);
                this.position = new Vector(this.startPos.x, this.startPos.y);
                this.velocity = new Vector(0, 0);
                this.radius = 15;
                this.visible = true; // Hide rocket when it explodes
            }
            applyForce(force) { this.velocity.add(force); }
            update() { this.position.add(this.velocity); }
            draw(ctx) {
                if (!this.visible) return;
                ctx.save();
                ctx.translate(this.position.x, this.position.y);
                let angle = Math.atan2(this.velocity.y, this.velocity.x);
                ctx.rotate(angle);
                ctx.rotate(Math.PI / 4); 
                ctx.font = "30px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText("üöÄ", 0, 0);
                ctx.restore();
            }
        }

        class Moon {
            constructor(x, y, mass) {
                this.position = new Vector(x, y);
                this.mass = mass;
                this.radius = Math.sqrt(this.mass) * 1.5; 
            }
            draw(ctx) {
                ctx.font = (this.radius * 2) + "px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText("üåë", this.position.x, this.position.y);
                ctx.strokeStyle = 'rgba(100,100,100,0.5)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.arc(this.position.x, this.position.y, this.radius, 0, Math.PI * 2);
                ctx.stroke();
            }
        }

        class Earth {
            constructor() {
                this.position = new Vector(700, canvas.height / 2);
                this.radius = 25;
            }
            draw(ctx) {
                ctx.font = "60px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.shadowBlur = 30;
                ctx.shadowColor = "#4488FF";
                ctx.fillText("üåç", this.position.x, this.position.y);
                ctx.shadowBlur = 0;
            }
        }

        // --- INITIALIZE ---
        let rocket = new Rocket();
        let earth = new Earth();

        // --- HELPER FUNCTIONS ---
        function spawnParticles(x, y, type, count) {
            for(let i=0; i<count; i++) {
                particles.push(new Particle(x, y, type));
            }
        }

        function calculateGravity(rocket, moon) {
            let force = moon.position.sub(rocket.position);
            let distance = force.mag();
            if (distance < moon.radius) distance = moon.radius; 
            if (distance > 1000) distance = 1000; 
            let strength = (gravityConstant * moon.mass) / (distance * distance);
            return force.normalize().mult(strength);
        }

        function checkCollisions() {
            // WIN
            if (rocket.position.dist(earth.position) < earth.radius) {
                gameStatus = "WON";
                isSimulating = false;
                rocket.visible = false; // Hide rocket
                spawnParticles(earth.position.x, earth.position.y, "confetti", 100);
            }

            // CRASH
            for (let moon of moons) {
                if (rocket.position.dist(moon.position) < moon.radius * 0.8) { 
                    gameStatus = "CRASHED";
                    isSimulating = false;
                    rocket.visible = false;
                    spawnParticles(rocket.position.x, rocket.position.y, "fire", 50);
                }
            }

            // LOST
            if (rocket.position.x < -100 || rocket.position.x > canvas.width + 100 || 
                rocket.position.y < -100 || rocket.position.y > canvas.height + 100) {
                gameStatus = "LOST";
                isSimulating = false;
            }
        }

        function drawGrid() {
            ctx.strokeStyle = '#2a2a40'; 
            ctx.lineWidth = 1;
            for(let x = 0; x <= canvas.width; x += 32) {
                ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
            }
            for(let y = 0; y <= canvas.height; y += 32) {
                ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
            }
        }

        const stars = [];
        for(let i=0; i<80; i++) {
            stars.push({
                x: Math.random() * canvas.width, 
                y: Math.random() * canvas.height, 
                size: Math.random() * 1.5
            });
        }
        function drawStars() {
            ctx.fillStyle = "rgba(255, 255, 255, 0.5)";
            for(let s of stars) {
                ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill();
            }
        }

        function drawMessage() {
            ctx.textAlign = "center";
            ctx.font = "bold 40px 'Segoe UI'";
            
            if (gameStatus === "WON") {
                ctx.fillStyle = "#00E676";
                ctx.fillText("üéâ MISSION COMPLETE! üéâ", canvas.width/2, 100);
            } else if (gameStatus === "CRASHED") {
                ctx.fillStyle = "#FF5722";
                ctx.fillText("üí• HULL BREACH! üí•", canvas.width/2, 100);
            } else if (gameStatus === "LOST") {
                ctx.fillStyle = "#FF9800";
                ctx.fillText("üì° SIGNAL LOST...", canvas.width/2, 100);
            }
        }

        // --- GAME LOOP ---
        function gameLoop() {
            ctx.fillStyle = "#000000"; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            drawGrid();
            drawStars();

            earth.draw(ctx);
            for (let moon of moons) moon.draw(ctx);

            if (isSimulating) {
                for (let moon of moons) {
                    let gravity = calculateGravity(rocket, moon);
                    rocket.applyForce(gravity);
                }
                rocket.update();
                checkCollisions();
            }

            // Update & Draw Particles (Even if game stopped)
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.update();
                p.draw(ctx);
                if (p.life <= 0) particles.splice(i, 1); // Remove dead particles
            }

            rocket.draw(ctx);
            drawMessage(); // Show text overlay

            requestAnimationFrame(gameLoop);
        }

        // --- CONTROLS ---
        canvas.addEventListener('mousedown', (e) => {
            if (e.button !== 0) return; 
            if (isSimulating) return;
            const rect = canvas.getBoundingClientRect();
            moons.push(new Moon(e.clientX - rect.left, e.clientY - rect.top, currentMass));
        });

        canvas.addEventListener('contextmenu', (e) => {
            e.preventDefault(); 
            if (isSimulating) return;
            const rect = canvas.getBoundingClientRect();
            const mouseVec = new Vector(e.clientX - rect.left, e.clientY - rect.top);
            moons = moons.filter(moon => mouseVec.dist(moon.position) > moon.radius);
        });

        document.getElementById('launchBtn').addEventListener('click', () => {
            // New: Allow re-launching immediately after win/loss without explicit reset
            let speedVal = parseFloat(document.getElementById('speedInput').value);
            
            // If we just finished a game, reset the rocket position automatically
            if (gameStatus === "WON" || gameStatus === "CRASHED" || gameStatus === "LOST") {
                 rocket = new Rocket(); // Reset position
                 particles = []; // Clear old explosions
            }
            
            rocket.velocity = new Vector(speedVal, 0); 
            rocket.visible = true;
            isSimulating = true;
            gameStatus = "FLYING";
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            rocket = new Rocket();
            particles = [];
            isSimulating = false;
            gameStatus = "PLANNING";
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            moons = [];
            rocket = new Rocket();
            particles = [];
            isSimulating = false;
            gameStatus = "PLANNING";
        });

        document.getElementById('setGravityBtn').addEventListener('click', () => {
            const val = document.getElementById('gravityInput').value;
            gravityConstant = parseInt(val);
            rocket = new Rocket();
            isSimulating = false;
        });

        window.setMoonSize = function(size, btnElement) {
            currentMass = size;
            document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
        };

        gameLoop();
    </script>
</body>
</html>
